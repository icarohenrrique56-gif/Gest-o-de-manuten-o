<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban PCM - Enterprise</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Sortable.js (Drag and Drop) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- DOMPurify (Segurança XSS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <!-- PapaParse (Leitura de CSV/Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Fonte -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sortable-ghost { opacity: 0.3; background: #dbeafe; border: 2px dashed #60a5fa; }
        .sortable-chosen { cursor: grabbing; opacity: 0.9; transform: scale(1.02); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .kanban-column-body { max-height: 75vh; overflow-y: auto; scrollbar-width: thin; }
        /* Notificações Toast */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; }
        .toast { transform: translateX(100%); transition: transform 0.3s ease-out; }
        .toast.show { transform: translateX(0); }
    </style>
</head>
<body class="antialiased text-gray-900 flex flex-col h-screen overflow-hidden">

<!-- Container de Notificações -->
<div id="toast-container" class="flex flex-col gap-2"></div>

<!-- Cabeçalho Profissional -->
<header class="bg-green-900 text-white shadow-lg flex-none z-40">
    <div class="w-full px-4 md:px-6 py-3 flex flex-wrap justify-between items-center">
        <!-- Logo -->
        <div class="flex items-center space-x-3">
            <div class="bg-white p-1.5 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-green-700" viewBox="0 0 24 24" fill="currentColor"><path d="M11.25 4.533A9.707 9.707 0 006 3a9.735 9.735 0 00-3.25.555.75.75 0 00-.5.707v14.25a.75.75 0 001 .75c.916-.143 1.964-.307 3-.45a50.189 50.189 0 0111.5 0c1.036.143 2.084.307 3 .45a.75.75 0 001-.75V4.262a.75.75 0 00-.5-.707A9.735 9.735 0 0018 3a9.707 9.707 0 00-5.25 1.533v16.103z"/></svg>
            </div>
            <div>
                <h1 class="text-xl font-bold leading-tight">PCM System</h1>
                <p class="text-xs text-green-300 font-light tracking-wide">Gestão de Ativos</p>
            </div>
        </div>

        <!-- Barra de Ferramentas -->
        <div class="flex items-center space-x-2 mt-2 md:mt-0">
            <!-- NOVO: Barra de Pesquisa -->
            <div class="relative">
                <input type="text" id="search-bar" placeholder="Pesquisar OS..." class="bg-green-800 text-white text-sm border border-green-700 rounded px-2 py-1.5 pl-8 outline-none focus:ring-1 focus:ring-green-400 placeholder-green-300">
                <svg class="w-4 h-4 text-green-300 absolute left-2.5 top-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </div>
            <!-- Filtro -->
            <select id="header-priority-select" class="bg-green-800 text-white text-sm border border-green-700 rounded px-2 py-1.5 outline-none focus:ring-1 focus:ring-green-400">
                <option value="all">Todas Prioridades</option>
                <option value="high">Alta</option>
                <option value="medium">Média</option>
                <option value="low">Baixa</option>
            </select>

            <!-- Botão Logs (Admin) -->
            <button id="btn-logs" class="hidden bg-green-800 hover:bg-green-700 text-white p-2 rounded transition-colors" title="Histórico de Atividades">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </button>

            <!-- Botão Importar CSV -->
            <label for="csv-upload" class="cursor-pointer bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-sm font-medium transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                <span class="hidden sm:inline">Importar</span>
            </label>
            <input type="file" id="csv-upload" accept=".csv" class="hidden">

            <!-- Botão Adicionar (Agora desabilitado por padrão) -->
            <button id="add-task-btn" class="bg-white text-green-900 hover:bg-gray-100 px-4 py-1.5 rounded text-sm font-bold transition-colors shadow flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed">
                <span>+</span> Nova OS
            </button>

            <!-- User Menu -->
            <div class="ml-2 border-l border-green-700 pl-3 flex flex-col items-end">
                <span id="user-email-display" class="text-xs text-green-100 font-medium">...</span>
                <!-- BOTÃO SAIR ATUALIZADO -->
                <button id="logout-btn" class="text-xs text-red-300 font-medium hover:bg-red-700 hover:text-white rounded px-2 py-1 transition-colors">Sair</button>
            </div>
        </div>
    </div>
</header>

<!-- Layout Kanban -->
<main class="flex-grow overflow-x-auto overflow-y-hidden bg-gray-100 p-4 md:p-6">
    <div class="flex h-full space-x-4 min-w-[1200px]"> <!-- min-w força scroll horizontal em telas pequenas -->
        
        <!-- Coluna Template (Reutilizável via JS, mas mantendo estrutura HTML para clareza) -->
        <!-- A RESTAURAR -->
        <div class="flex flex-col w-80 bg-gray-50 rounded-lg shadow border-t-4 border-red-500 h-full max-h-full">
            <div class="p-3 border-b border-gray-200 flex justify-between items-center bg-white rounded-t-lg">
                <h3 class="font-bold text-gray-700 text-sm uppercase flex items-center gap-2">
                    A Restaurar
                    <span id="count-col-restaurar" class="bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full">0</span>
                </h3>
            </div>
            <div id="col-restaurar" class="p-3 space-y-3 flex-grow overflow-y-auto kanban-column-body" data-column-id="col-restaurar"></div>
        </div>

        <!-- EM DIAGNÓSTICO -->
        <div class="flex flex-col w-80 bg-gray-50 rounded-lg shadow border-t-4 border-yellow-500 h-full max-h-full">
            <div class="p-3 border-b border-gray-200 flex justify-between items-center bg-white rounded-t-lg">
                <h3 class="font-bold text-gray-700 text-sm uppercase flex items-center gap-2">
                    Em Diagnóstico
                    <span id="count-col-diagnostico" class="bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full">0</span>
                </h3>
            </div>
            <div id="col-diagnostico" class="p-3 space-y-3 flex-grow overflow-y-auto kanban-column-body" data-column-id="col-diagnostico"></div>
        </div>

        <!-- EM RESTAURAÇÃO -->
        <div class="flex flex-col w-80 bg-gray-50 rounded-lg shadow border-t-4 border-orange-500 h-full max-h-full">
            <div class="p-3 border-b border-gray-200 flex justify-between items-center bg-white rounded-t-lg">
                <h3 class="font-bold text-gray-700 text-sm uppercase flex items-center gap-2">
                    Em Restauração
                    <span id="count-col-restauracao" class="bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full">0</span>
                </h3>
            </div>
            <div id="col-restauracao" class="p-3 space-y-3 flex-grow overflow-y-auto kanban-column-body" data-column-id="col-restauracao"></div>
        </div>

        <!-- EM TESTE -->
        <div class="flex flex-col w-80 bg-gray-50 rounded-lg shadow border-t-4 border-blue-500 h-full max-h-full">
            <div class="p-3 border-b border-gray-200 flex justify-between items-center bg-white rounded-t-lg">
                <h3 class="font-bold text-gray-700 text-sm uppercase flex items-center gap-2">
                    Qualidade/Teste
                    <span id="count-col-teste" class="bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full">0</span>
                </h3>
            </div>
            <div id="col-teste" class="p-3 space-y-3 flex-grow overflow-y-auto kanban-column-body" data-column-id="col-teste"></div>
        </div>

        <!-- PRONTO -->
        <div class="flex flex-col w-80 bg-gray-50 rounded-lg shadow border-t-4 border-green-500 h-full max-h-full">
            <div class="p-3 border-b border-gray-200 flex justify-between items-center bg-white rounded-t-lg">
                <h3 class="font-bold text-gray-700 text-sm uppercase flex items-center gap-2">
                    Pronto
                    <span id="count-col-pronto" class="bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full">0</span>
                </h3>
            </div>
            <div id="col-pronto" class="p-3 space-y-3 flex-grow overflow-y-auto kanban-column-body" data-column-id="col-pronto"></div>
        </div>

    </div>
</main>

<!-- MODAL TAREFA (Adicionar/Editar) -->
<div id="task-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4 transform transition-all">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 id="modal-title" class="text-lg font-bold text-gray-800">Nova Ordem de Serviço</h3>
            <button onclick="closeTaskModal()" class="text-gray-400 hover:text-gray-600">✕</button>
        </div>
        <form id="task-form" class="p-4 space-y-4">
            <input type="hidden" id="task-id-hidden">
            
            <!-- SEÇÃO QR CODE (NOVA) -->
            <div id="qr-code-wrapper" class="hidden text-center p-4 bg-gray-100 rounded-lg items-center justify-center flex flex-col">
                <img id="qr-code-img" src="https://placehold.co/150x150/eee/ccc?text=QR" alt="QR Code" class="w-36 h-36 rounded-md border">
                <p class="text-xs text-gray-600 mt-2">QR Code para esta OS</p>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Código / OS</label>
                <input type="text" id="task-id-input" class="w-full border border-gray-300 rounded p-2 focus:border-green-500 focus:ring-1 focus:ring-green-500 outline-none" placeholder="Ex: OS-9988">
                <div id="task-id-display" class="text-lg font-bold text-gray-800 hidden"></div>
            </div>
            
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Descrição do Serviço</label>
                <textarea id="task-text-input" rows="3" class="w-full border border-gray-300 rounded p-2 focus:border-green-500 focus:ring-1 focus:ring-green-500 outline-none" placeholder="Detalhes da peça ou serviço..." required></textarea>
            </div>

            <!-- NOVO: Campo Responsável -->
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Responsável</label>
                <input type="text" id="task-owner-input" class="w-full border border-gray-300 rounded p-2 focus:border-green-500 focus:ring-1 focus:ring-green-500 outline-none" placeholder="Ex: João Silva, Equipe Elétrica">
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Prioridade</label>
                <div class="flex gap-2">
                    <label class="cursor-pointer">
                        <input type="radio" name="priority" value="low" class="peer sr-only">
                        <div class="px-3 py-1 rounded border border-gray-300 text-gray-600 peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-blue-500 text-sm">Baixa</div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="priority" value="medium" class="peer sr-only" checked>
                        <div class="px-3 py-1 rounded border border-gray-300 text-gray-600 peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500 text-sm">Média</div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="priority" value="high" class="peer sr-only">
                        <div class="px-3 py-1 rounded border border-gray-300 text-gray-600 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500 text-sm">Alta</div>
                    </label>
                </div>
            </div>

            <div class="pt-2 flex justify-end gap-2">
                <button type="button" onclick="closeTaskModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded text-sm">Cancelar</button>
                <button type="submit" id="save-task-btn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-medium shadow">Salvar OS</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL LOGS (Histórico) -->
<div id="logs-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl m-4 flex flex-col max-h-[80vh]">
        <div class="flex justify-between items-center p-4 border-b bg-gray-50 rounded-t-lg">
            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                <svg class="w-5 h-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                Histórico de Atividades
            </h3>
            <button onclick="document.getElementById('logs-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">✕</button>
        </div>
        <div class="p-0 overflow-y-auto flex-grow bg-gray-50">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-200 sticky top-0">
                    <tr>
                        <th class="px-4 py-3">Data/Hora</th>
                        <th class="px-4 py-3">Usuário</th>
                        <th class="px-4 py-3">Ação</th>
                        <th class="px-4 py-3">Detalhes</th>
                    </tr>
                </thead>
                <tbody id="logs-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Logs serão inseridos via JS -->
                    <tr><td colspan="4" class="p-4 text-center text-gray-500">Carregando logs...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL COMENTÁRIO DE STATUS -->
<div id="status-comment-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
        <div class="p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Descrever a Etapa</h3>
            <p class="text-sm text-gray-600 mb-4">O que foi feito nesta etapa? (ex: "Iniciando reparos", "Aguardando peças")</p>
            <textarea id="status-comment-input" rows="4" class="w-full border border-gray-300 rounded-lg p-3 focus:border-green-500 focus:ring-1 focus:ring-green-500 outline-none text-sm" placeholder="Digite a descrição da etapa..."></textarea>
        </div>
        <div class="bg-gray-50 p-4 flex justify-end gap-3 rounded-b-lg">
            <button id="cancel-status-comment-btn" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded text-sm">Cancelar</button>
            <button id="save-status-comment-btn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-medium shadow">Salvar e Mover</button>
        </div>
    </div>
</div>

<!-- MODAL CONFIRMAÇÃO DELETE -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4">
        <div class="p-6">
            <h3 class="text-lg font-bold text-gray-900">Confirmar Exclusão</h3>
            <p class="text-sm text-gray-600 mt-2">Tem certeza que deseja excluir esta OS? Esta ação é permanente e será registrada.</p>
            <p id="delete-os-id" class="text-sm font-bold text-red-600 mt-2"></p>
        </div>
        <div class="bg-gray-50 p-4 flex justify-end gap-3 rounded-b-lg">
            <button id="cancel-delete-btn" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded text-sm">Cancelar</button>
            <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm font-medium shadow">Sim, Excluir</button>
        </div>
    </div>
</div>


<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script src="firebase-init.js"></script>
<!-- NOVA LÓGICA -->
<script src="app.js"></script> 
</body>
</html>